name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  typescript:
    name: TypeScript
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sdks/typescript
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: sdks/typescript/package-lock.json

      - run: npm ci
      - run: npm run typecheck
      - run: npm run build
      - run: npm test -- --coverage

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          flags: typescript
          files: ./sdks/typescript/coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  python:
    name: Python
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
    defaults:
      run:
        working-directory: sdks/python
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Type check
        run: |
          pip install mypy
          mypy renamed

      - name: Run tests with coverage
        run: pytest --cov=renamed --cov-report=xml

      - name: Upload coverage
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          flags: python
          files: ./sdks/python/coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  go:
    name: Go
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sdks/go
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-go@v6
        with:
          go-version: '1.21'

      - name: Build
        run: go build ./...

      - name: Test with coverage
        run: go test -coverprofile=coverage.out ./...

      - name: Vet
        run: go vet ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          flags: go
          files: ./sdks/go/coverage.out
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  java:
    name: Java
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: ['11', '17', '21']
    defaults:
      run:
        working-directory: sdks/java
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'

      - name: Checkstyle
        run: mvn checkstyle:check -B

      - name: Build
        run: mvn compile -B

      - name: Test
        run: mvn test -B

      - name: Upload coverage
        if: matrix.java-version == '17'
        uses: codecov/codecov-action@v5
        with:
          flags: java
          files: ./sdks/java/target/site/jacoco/jacoco.xml
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

  csharp:
    name: C#
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet-version: ['6.0', '8.0']
    defaults:
      run:
        working-directory: sdks/csharp
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ matrix.dotnet-version }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore

      - name: Test
        run: dotnet test --no-build --verbosity normal

  ruby:
    name: Ruby
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby-version: ['3.1', '3.2', '3.3']
    defaults:
      run:
        working-directory: sdks/ruby
    steps:
      - uses: actions/checkout@v5

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
          bundler-cache: true
          working-directory: sdks/ruby

      - name: Run tests
        run: bundle exec rake test

  rust:
    name: Rust
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: sdks/rust
    steps:
      - uses: actions/checkout@v5

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            sdks/rust/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('sdks/rust/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --check

      - name: Clippy
        run: cargo clippy -- -D warnings

      - name: Build
        run: cargo build

      - name: Test
        run: cargo test

  swift:
    name: Swift
    runs-on: macos-latest
    defaults:
      run:
        working-directory: sdks/swift
    steps:
      - uses: actions/checkout@v5

      - name: Build
        run: swift build

      - name: Test
        run: swift test

  php:
    name: PHP
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3']
    defaults:
      run:
        working-directory: sdks/php
    steps:
      - uses: actions/checkout@v5

      - uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: composer:v2
          coverage: pcov

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('sdks/php/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: PHPStan
        run: composer analyse

      - name: Run tests with coverage
        run: ./vendor/bin/phpunit --coverage-clover=coverage.xml

      - name: Upload coverage
        if: matrix.php-version == '8.3'
        uses: codecov/codecov-action@v5
        with:
          flags: php
          files: ./sdks/php/coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true
